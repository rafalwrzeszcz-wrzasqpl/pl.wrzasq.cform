<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ResourceModel.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">WrzasqPl::AWS::DynamoDbItem resource</a> &gt; <a href="index.source.html" class="el_package">pl.wrzasq.cform.resource.aws.dynamodbitem.model</a> &gt; <span class="el_source">ResourceModel.kt</span></div><h1>ResourceModel.kt</h1><pre class="source lang-java linenums">/**
 * This file is part of the pl.wrzasq.cform.
 *
 * @license http://mit-license.org/ The MIT license
 * @copyright 2022 © by Rafał Wrzeszcz - Wrzasq.pl.
 */

package pl.wrzasq.cform.resource.aws.dynamodbitem.model

import com.fasterxml.jackson.annotation.JsonIgnore
import com.fasterxml.jackson.annotation.JsonProperty
import org.json.JSONObject
import software.amazon.awssdk.core.BytesWrapper
import software.amazon.awssdk.core.SdkBytes
import software.amazon.awssdk.services.dynamodb.model.AttributeValue
import software.amazon.awssdk.services.dynamodb.model.DeleteItemRequest
import software.amazon.awssdk.services.dynamodb.model.GetItemRequest
import software.amazon.awssdk.services.dynamodb.model.GetItemResponse
import software.amazon.awssdk.services.dynamodb.model.PutItemRequest

/**
 * AWS account resource description.
 */
<span class="fc" id="L24">class ResourceModel {</span>
    /**
     * Target table name.
     */
    @JsonProperty(&quot;TableName&quot;)
<span class="fc" id="L29">    var tableName: String? = null</span>

    /**
     * Record identifier.
     */
    @JsonProperty(&quot;Id&quot;)
<span class="fc" id="L35">    var id: String? = null</span>

    /**
     * Object key structure.
     */
    @JsonProperty(&quot;Key&quot;)
<span class="fc" id="L41">    var key: Map&lt;String, Map&lt;String, Any&gt;&gt;? = null</span>

    /**
     * Additional data fields.
     */
    @JsonProperty(&quot;Data&quot;)
<span class="fc" id="L47">    var data: Map&lt;String, Map&lt;String, Any&gt;&gt; = emptyMap()</span>

    /**
     * Persistem item properties.
     */
    @JsonProperty(&quot;Item&quot;)
<span class="fc" id="L53">    var item: Map&lt;String, Map&lt;String, Any&gt;&gt;? = null</span>

    /**
     * Primary identifier of the resource.
     */
    @get:JsonIgnore
    val primaryIdentifier: JSONObject?
        get() {
<span class="nc" id="L61">            val identifier = JSONObject()</span>

<span class="nc bnc" id="L63" title="All 2 branches missed.">            if (tableName != null) {</span>
<span class="nc" id="L64">                identifier.put(IDENTIFIER_KEY_TABLE_NAME, tableName)</span>
            }
<span class="nc bnc" id="L66" title="All 2 branches missed.">            if (id != null) {</span>
<span class="nc" id="L67">                identifier.put(IDENTIFIER_KEY_ID, id)</span>
            }

            // only return the identifier if it can be used, i.e. if all components are present
<span class="nc bnc" id="L71" title="All 2 branches missed.">            return if (identifier.isEmpty) null else identifier</span>
        }

    /**
     * All of the unique identifiers.
     */
    @get:JsonIgnore
<span class="nc" id="L78">    val additionalIdentifiers: List&lt;Any&gt;? = null</span>

    companion object {
        /**
         * CloudFormation resource type.
         */
        @JsonIgnore
<span class="fc" id="L85">        val TYPE_NAME = &quot;WrzasqPl::AWS::DynamoDbItem&quot;</span>

        /**
         * Property path to table name.
         */
        @JsonIgnore
<span class="pc" id="L91">        val IDENTIFIER_KEY_TABLE_NAME = &quot;/properties/TableName&quot;</span>

        /**
         * Property path to record ID.
         */
        @JsonIgnore
<span class="pc" id="L97">        val IDENTIFIER_KEY_ID = &quot;/properties/Id&quot;</span>
    }
}

/**
 * Request to read a resource.
 *
 * @return AWS service request to read resource tgs.
 */
<span class="fc" id="L106">fun ResourceModel.toReadRequest(): GetItemRequest = GetItemRequest.builder()</span>
<span class="fc" id="L107">    .tableName(tableName)</span>
<span class="pc bpc" id="L108" title="1 of 2 branches missed.">    .key(key?.mapValues { convertToAttribute(it.value) })</span>
<span class="fc" id="L109">    .build()</span>

/**
 * Request to create a resource.
 *
 * @return AWS service request to create a resource.
 */
<span class="fc" id="L116">fun ResourceModel.toCreateRequest(): PutItemRequest = PutItemRequest.builder()</span>
<span class="fc" id="L117">    .tableName(tableName)</span>
<span class="pc bpc" id="L118" title="1 of 2 branches missed.">    .item(((key ?: emptyMap()) + data).mapValues { convertToAttribute(it.value) })</span>
<span class="fc" id="L119">    .build()</span>

/**
 * Request to delete a resource.
 *
 * @return AWS service request to delete a resource.
 */
<span class="fc" id="L126">fun ResourceModel.toDeleteRequest(): DeleteItemRequest = DeleteItemRequest.builder()</span>
<span class="fc" id="L127">    .tableName(tableName)</span>
<span class="pc bpc" id="L128" title="1 of 2 branches missed.">    .key(key?.mapValues { convertToAttribute(it.value) })</span>
<span class="fc" id="L129">    .build()</span>

/**
 * Translates resource object from SDK into a resource model.
 *
 * @param describeResponse AWS service describe resource response.
 * @param model Input model for identity properties.
 * @return Resource model.
 */
fun fromReadResponse(
    describeResponse: GetItemResponse,
    model: ResourceModel
<span class="fc" id="L141">) = ResourceModel().apply {</span>
<span class="fc" id="L142">    tableName = model.tableName</span>
<span class="fc" id="L143">    id = model.id</span>
<span class="fc" id="L144">    key = model.key</span>
<span class="fc" id="L145">    data = model.data</span>
<span class="fc" id="L146">    item = describeResponse.item().mapValues { convertToMap(it.value) }</span>
<span class="fc" id="L147">}</span>

<span class="nc bnc" id="L149" title="All 2 branches missed.">private fun convertToCollection(value: Any?) = if (value is Collection&lt;*&gt;) {</span>
<span class="nc" id="L150">    value.map(Any?::toString)</span>
} else {
<span class="nc" id="L152">    listOf(value.toString())</span>
<span class="nc" id="L153">}</span>

<span class="nc" id="L155">private fun convertToAttribute(value: Map&lt;*, Any?&gt;): AttributeValue = value</span>
<span class="nc" id="L156">    .mapKeys { it.key.toString() }</span>
<span class="nc" id="L157">    .entries</span>
<span class="nc" id="L158">    .fold(AttributeValue.builder()) { accumulator, entry -&gt;</span>
<span class="nc bnc" id="L159" title="All 11 branches missed.">        when (entry.key) {</span>
<span class="nc" id="L160">            &quot;S&quot; -&gt; accumulator.s(entry.value.toString())</span>
<span class="nc" id="L161">            &quot;N&quot; -&gt; accumulator.n(entry.value.toString())</span>
<span class="nc" id="L162">            &quot;B&quot; -&gt; accumulator.b(SdkBytes.fromUtf8String(entry.value.toString()))</span>
<span class="nc" id="L163">            &quot;SS&quot; -&gt; accumulator.ss(convertToCollection(entry.value))</span>
<span class="nc" id="L164">            &quot;NS&quot; -&gt; accumulator.ns(convertToCollection(entry.value))</span>
<span class="nc" id="L165">            &quot;BS&quot; -&gt; accumulator.bs(convertToCollection(entry.value).map(SdkBytes::fromUtf8String))</span>
            &quot;M&quot; -&gt; {
<span class="nc" id="L167">                val target = mutableMapOf&lt;String, AttributeValue&gt;()</span>
<span class="nc" id="L168">                val nested = entry.value // used for smart-case</span>

<span class="nc bnc" id="L170" title="All 2 branches missed.">                if (nested is Map&lt;*, *&gt;) {</span>
<span class="nc" id="L171">                    nested.forEach { (key, single) -&gt;</span>
<span class="nc bnc" id="L172" title="All 2 branches missed.">                        if (single is Map&lt;*, *&gt;) {</span>
<span class="nc" id="L173">                            target[key.toString()] = convertToAttribute(single)</span>
                        }
<span class="nc" id="L175">                    }</span>
                }

<span class="nc" id="L178">                accumulator.m(target)</span>
            }
            &quot;L&quot; -&gt; {
<span class="nc" id="L181">                val nested = entry.value // used for smart-case</span>

<span class="nc bnc" id="L183" title="All 2 branches missed.">                if (nested is Collection&lt;*&gt;) {</span>
<span class="nc" id="L184">                    accumulator.l(</span>
<span class="nc" id="L185">                        nested</span>
<span class="nc" id="L186">                            .filterIsInstance&lt;Map&lt;*, *&gt;&gt;()</span>
<span class="nc" id="L187">                            .map(::convertToAttribute)</span>
                    )
                }

<span class="nc" id="L191">                accumulator</span>
            }
<span class="nc bnc" id="L193" title="All 2 branches missed.">            &quot;BOOL&quot; -&gt; accumulator.bool(entry.value.toString().lowercase() != &quot;false&quot;)</span>
<span class="nc" id="L194">            &quot;NUL&quot; -&gt; accumulator.nul(true)</span>
<span class="nc" id="L195">            else -&gt; accumulator</span>
        }
    }
<span class="nc" id="L198">        .build()</span>

private fun convertToMap(value: AttributeValue): Map&lt;String, Any&gt; {
<span class="fc" id="L201">    val target = mutableMapOf&lt;String, Any&gt;()</span>

<span class="fc bfc" id="L203" title="All 2 branches covered.">    value.s()?.let { target[&quot;S&quot;] = it }</span>
<span class="fc bfc" id="L204" title="All 2 branches covered.">    value.n()?.let { target[&quot;N&quot;] = it }</span>
<span class="pc bpc" id="L205" title="1 of 2 branches missed.">    value.b()?.let { target[&quot;B&quot;] = it.asUtf8String() }</span>
<span class="pc bpc" id="L206" title="1 of 2 branches missed.">    if (value.hasSs()) target[&quot;SS&quot;] = value.ss()</span>
<span class="pc bpc" id="L207" title="1 of 2 branches missed.">    if (value.hasNs()) target[&quot;NS&quot;] = value.ns()</span>
<span class="pc bpc" id="L208" title="1 of 2 branches missed.">    if (value.hasBs()) target[&quot;BS&quot;] = value.bs().map(BytesWrapper::asUtf8String)</span>
<span class="pc bpc" id="L209" title="1 of 2 branches missed.">    if (value.hasM()) target[&quot;M&quot;] = value.m().mapValues { convertToMap(it.value) }</span>
<span class="pc bpc" id="L210" title="1 of 2 branches missed.">    if (value.hasL()) target[&quot;L&quot;] = value.l().map(::convertToMap)</span>
<span class="pc bpc" id="L211" title="1 of 2 branches missed.">    value.bool()?.let { target[&quot;BOOL&quot;] = it }</span>
<span class="fc bfc" id="L212" title="All 2 branches covered.">    value.nul()?.let { target[&quot;NUL&quot;] = it }</span>

<span class="fc" id="L214">    return target</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>