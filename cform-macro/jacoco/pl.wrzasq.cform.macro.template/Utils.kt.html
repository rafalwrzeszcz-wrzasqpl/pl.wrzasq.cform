<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Utils.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">CloudFormation macro processor.</a> &gt; <a href="index.source.html" class="el_package">pl.wrzasq.cform.macro.template</a> &gt; <span class="el_source">Utils.kt</span></div><h1>Utils.kt</h1><pre class="source lang-java linenums">/**
 * This file is part of the pl.wrzasq.cform.
 *
 * @license http://mit-license.org/ The MIT license
 * @copyright 2021, 2024 © by Rafał Wrzeszcz - Wrzasq.pl.
 */

package pl.wrzasq.cform.macro.template

import pl.wrzasq.cform.macro.model.ResourceDefinition

/**
 * Parameters section key.
 */
const val SECTION_PARAMETERS = &quot;Parameters&quot;

/**
 * Conditions section key.
 */
const val SECTION_CONDITIONS = &quot;Conditions&quot;

/**
 * Resources section key.
 */
const val SECTION_RESOURCES = &quot;Resources&quot;

/**
 * Resources section key.
 */
const val SECTION_OUTPUTS = &quot;Outputs&quot;

/**
 * Type key.
 */
const val PROPERTY_KEY_TYPE = &quot;Type&quot;

/**
 * DependsOn key.
 */
const val PROPERTY_KEY_DEPENDSON = &quot;DependsOn&quot;

/**
 * Condition key.
 */
const val PROPERTY_KEY_CONDITION = &quot;Condition&quot;

/**
 * Properties key.
 */
const val PROPERTY_KEY_PROPERTIES = &quot;Properties&quot;

/**
 * Safely converts value to a typed map.
 *
 * @param input Input object.
 * @return Typed map.
 */
fun asMap(input: Any): Map&lt;String, Any&gt; {
<span class="fc" id="L59">    val output = mutableMapOf&lt;String, Any&gt;()</span>
<span class="fc bfc" id="L60" title="All 2 branches covered.">    if (input is Map&lt;*, *&gt;) {</span>
<span class="fc bfc" id="L61" title="All 2 branches covered.">        for ((key, value) in input) {</span>
<span class="fc bfc" id="L62" title="All 2 branches covered.">            if (value != null) {</span>
<span class="fc" id="L63">                output[key.toString()] = value</span>
            }
        }
    }
<span class="fc" id="L67">    return output</span>
}

/**
 * Converts optional value to a typed map.
 *
 * @param input Input object.
 * @return Typed map.
 */
<span class="pc bpc" id="L76" title="1 of 4 branches missed.">fun asMapAlways(input: Any?) = input?.let(::asMap) ?: emptyMap()</span>

/**
 * Handles optional property by removing it from generic properties pool.
 *
 * @param key Property key.
 * @param then Property action.
 * @param defaultValue Default property value.
 * @return Map without consumed key.
 */
<span class="fc" id="L86">fun Map&lt;String, Any&gt;.popProperty(key: String, then: (Any) -&gt; Unit, defaultValue: Any? = null): Map&lt;String, Any&gt; {</span>
<span class="fc bfc" id="L87" title="All 2 branches covered.">    if (containsKey(key)) {</span>
<span class="pc bpc" id="L88" title="1 of 2 branches missed.">        this[key]?.let(then)</span>
<span class="fc bfc" id="L89" title="All 2 branches covered.">        return filterKeys { it != key }</span>
<span class="fc bfc" id="L90" title="All 2 branches covered.">    } else if (defaultValue != null) {</span>
<span class="fc" id="L91">        then(defaultValue)</span>
    }
<span class="fc" id="L93">    return this</span>
}

/**
 * Performs mapping only for selected entries in the map.
 *
 * @param handlers Mappers for selected keys.
 * @return Mapped structure.
 */
<span class="fc" id="L102">fun Map&lt;String, Any&gt;.mapSelected(vararg handlers: Pair&lt;String, (Any) -&gt; Any&gt;) = mapValues {</span>
<span class="pc bpc" id="L103" title="1 of 4 branches missed.">    mapOf(*handlers)[it.key]?.invoke(it.value) ?: it.value</span>
<span class="fc" id="L104">}</span>

/**
 * Performs mapping only for single selected key in map.
 *
 * @param key Desired key.
 * @param handler Mapping function.
 * @return Mapped structure.
 */
<span class="fc" id="L113">fun Map&lt;String, Any&gt;.mapSelected(key: String, handler: (Any) -&gt; Any) = mapSelected(key to handler)</span>

/**
 * Performs mapping of only values of each pair.
 *
 * @param transform Mapping function.
 * @return Mapped structure.
 */
<span class="fc" id="L121">fun Map&lt;String, Any&gt;.mapValuesOnly(transform: (Any) -&gt; Any) = mapValues { transform(it.value) }</span>

/**
 * Rebuilds resource definition with different properties.
 *
 * @param input Initial resource definition.
 * @param properties New properties.
 * @return New definition.
 */
fun rebuildResource(
    input: Any,
    properties: Map&lt;String, Any&gt;,
<span class="fc" id="L133">) = asMap(input) + mapOf(PROPERTY_KEY_PROPERTIES to properties)</span>

/**
 * Creates resource definition structure.
 *
 * @param model Resource model.
 * @return Resource structure.
 */
fun createResource(model: ResourceDefinition): Pair&lt;String, Map&lt;String, Any&gt;&gt; {
<span class="fc" id="L142">    val resource = mutableMapOf&lt;String, Any&gt;(PROPERTY_KEY_TYPE to model.type)</span>
<span class="pc bpc" id="L143" title="1 of 6 branches missed.">    if (!model.condition.isNullOrEmpty()) {</span>
<span class="fc" id="L144">        resource[PROPERTY_KEY_CONDITION] = model.condition</span>
    }
<span class="fc bfc" id="L146" title="All 4 branches covered.">    if (model.dependsOn.isNotEmpty()) {</span>
<span class="fc" id="L147">        resource[PROPERTY_KEY_DEPENDSON] = model.dependsOn</span>
    }
<span class="fc bfc" id="L149" title="All 4 branches covered.">    if (model.properties.isNotEmpty()) {</span>
<span class="fc" id="L150">        resource[PROPERTY_KEY_PROPERTIES] = model.properties</span>
    }
<span class="fc" id="L152">    return model.id to resource</span>
}

/**
 * Converts template fragment to resource model.
 *
 * @param id Logical ID.
 * @param input Template fragment.
 * @return Model structure.
 */
fun asDefinition(id: String, input: Any): ResourceDefinition {
<span class="fc" id="L163">    val data = asMap(input)</span>

<span class="fc" id="L165">    return ResourceDefinition(</span>
<span class="fc" id="L166">        id = id,</span>
        // dummy fallback, should never be needed
<span class="pc bpc" id="L168" title="1 of 4 branches missed.">        type = data[PROPERTY_KEY_TYPE]?.toString() ?: &quot;&quot;,</span>
<span class="fc bfc" id="L169" title="All 2 branches covered.">        condition = data[PROPERTY_KEY_CONDITION]?.toString(),</span>
<span class="pc bpc" id="L170" title="1 of 4 branches missed.">        dependsOn = data[PROPERTY_KEY_DEPENDSON]?.let {</span>
<span class="fc bfc" id="L171" title="All 2 branches covered.">            if (it is List&lt;*&gt;) it.filterNotNull().map(Any::toString) else emptyList()</span>
<span class="fc" id="L172">        } ?: emptyList(),</span>
<span class="pc bpc" id="L173" title="1 of 4 branches missed.">        properties = data[PROPERTY_KEY_PROPERTIES]?.let(::asMap) ?: emptyMap(),</span>
    )
}

/**
 * Model method binding.
 *
 * @return Plain map structure.
 */
<span class="fc" id="L182">fun ResourceDefinition.build() = createResource(this)</span>

/**
 * Model method binding.
 *
 * @param key Property key.
 * @param then Property action.
 * @param defaultValue Default property value.
 * @return Map without consumed key.
 */
<span class="fc" id="L192">fun ResourceDefinition.popProperty(key: String, then: (Any) -&gt; Unit, defaultValue: Any? = null) = copy(</span>
<span class="fc" id="L193">    properties = properties.popProperty(key, then, defaultValue),</span>
<span class="fc" id="L194">)</span>
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>