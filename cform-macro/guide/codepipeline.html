<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.9.2 at 2023-07-11 
 | Rendered using Apache Maven Fluido Skin 1.6
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20230711" />
    <meta http-equiv="Content-Language" content="en" />
    <title>CloudFormation macro processor. &#x2013; CodePipeline</title>
    <link rel="stylesheet" href="../css/apache-maven-fluido-1.6.min.css" />
    <link rel="stylesheet" href="../css/site.css" />
    <link rel="stylesheet" href="../css/print.css" media="print" />
      <script type="text/javascript" src="../js/apache-maven-fluido-1.6.min.js"></script>
      </head>
    <body class="topBarDisabled">
      <div class="container-fluid">
      <div id="banner">
        <div class="pull-left"><div id="bannerLeft"><h2>CloudFormation macro processor.</h2>
</div>
</div>
        <div class="pull-right"><a href="https://wrzasq.pl" id="bannerRight"><h2><img src="https://static.wrzasq.pl/images/wrzasqpl.png" alt="Wrzasq.pl"/></h2>
</a></div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
        </ul>
      </div>
      <div class="row-fluid">
        <div id="leftColumn" class="span2">
          <div class="well sidebar-nav">
<ul class="nav nav-list">
          <li class="nav-header">Main</li>
    <li><a href="https://github.com/rafalwrzeszcz-wrzasqpl/pl.wrzasq.cform/" class="externalLink" title="GitHub project"><span class="none"></span>GitHub project</a>  </li>
    <li><a href="https://wrzasq.pl/" class="externalLink" title="Wrzasq.pl"><span class="none"></span>Wrzasq.pl</a>  </li>
    <li><a href="https://www.facebook.com/wrzasqpl" class="externalLink" title="Wrzasq.pl @ Facebook"><span class="none"></span>Wrzasq.pl @ Facebook</a>  </li>
    <li><a href="https://www.linkedin.com/company/wrzasq-pl/" class="externalLink" title="Wrzasq.pl @ LinkedIn"><span class="none"></span>Wrzasq.pl @ LinkedIn</a>  </li>
          <li class="nav-header">Parent Project</li>
    <li><a href="../../index.html" title="WrzasqPl CForm"><span class="none"></span>WrzasqPl CForm</a>  </li>
          <li class="nav-header">Guide</li>
    <li><a href="../guide/deployment.html" title="Deployment"><span class="none"></span>Deployment</a>  </li>
    <li><a href="../guide/matrix.html" title="Matrix resources"><span class="none"></span>Matrix resources</a>  </li>
    <li><a href="../guide/apigateway.html" title="API Gateway"><span class="none"></span>API Gateway</a>  </li>
    <li class="active"><a href="#"><span class="none"></span>CodePipeline</a>
  </li>
    <li><a href="../guide/general.html" title="General improvements"><span class="none"></span>General improvements</a>  </li>
          <li class="nav-header">Project Documentation</li>
    <li><a href="../project-info.html" title="Project Information"><span class="icon-chevron-right"></span>Project Information</a>  </li>
    <li><a href="../project-reports.html" title="Project Reports"><span class="icon-chevron-right"></span>Project Reports</a>  </li>
  </ul>
          <hr />
          <div id="poweredBy">
              <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
  <a href="https://maven.apache.org/" title="Maven" class="builtBy"><img class="builtBy"  alt="Apache Maven" src="https://maven.apache.org/images/logos/maven-feather.png"    /></a>
<a href="https://wrzasq.pl" title="Wrzasq.pl" class="builtBy"><img class="builtBy"  alt="Wrzasq.pl" src="https://static.wrzasq.pl/images/wrzasqpl.png"    /></a>
              </div>
          </div>
        </div>
        <div id="bodyColumn"  class="span10" >
<!---
# This file is part of the pl.wrzasq.cform.
#
# @license http://mit-license.org/ The MIT license
# @copyright 2021 © by Rafał Wrzeszcz - Wrzasq.pl.
-->
<h1>CodePipeline</h1>
<p>Building automation pipeline is a crucial part of DevOps approach - <b>CodePipeline</b> is the natural choice in <b>AWS</b> ecosystem. Unfortunately expressing it in <b>CloudFormation</b> very often requires verbose syntax and manual handling of all aspects (as usual in CloudFormation). This macro makes at least some of them transparent, implicit or automated.</p><section>
<h2><a name="Definition"></a>Definition</h2>
<p>The main part of pipeline definition is its structure. There are few changes to the standard CloudFormation notation of <code>AWS::CodePipeline::Pipeline</code>:</p>
<ul>

<li>within each stage actions are defined as mapping, with action names as keys;</li>
<li><code>RunOrder</code> is defined automatically based on artifacts and namespace variables used.</li>
</ul>
<p>If you define structure in the normal way, macro will simply not apply processing leaving your plain definition.</p>
<p><b>Note:</b> Stage definitions order matters as it defines execution order, but on actions level it is not important as by default all actions are executed in parallel and in case of dependencies order is managed with <code>RunOrder</code> property.</p></section><section>
<h2><a name="Conditions"></a>Conditions</h2>
<p>In each stage and action you can optionally define property <code>Condition</code> that will turn given stage or action definition into conditional statement - this property prevents from changing pipeline structure keeping all the entries at the same levels:</p>

<div class="source">
<div class="source"><pre class="prettyprint">    DeployPipeline:
        Type: &quot;AWS::CodePipeline::Pipeline&quot;
        Properties:
            Stages:
                -
                    Name: &quot;Checkout&quot;
                    Actions:
                        S3:
                            Condition: &quot;HasCheckout&quot;
                            ActionTypeId:
                                Category: &quot;Source&quot;
                                Owner: &quot;AWS&quot;
                                Provider: &quot;S3&quot;
                                Version: &quot;1&quot;
                            Configuration:
                                S3Bucket: !ImportValue &quot;root:v1:codepipeline:artifacts-bucket:name&quot;
                                S3ObjectKey: !Sub &quot;${ProjectName}/checkout.zip&quot;
                            OutputArtifacts:
                                -
                                    Name: &quot;checkout&quot;
                        Git:
                            # &#x2026;
                -
                    Name: &quot;Promote&quot;
                    Condition: &quot;HasNextStage&quot;
                    Actions:
                        # &#x2026;
</pre></div></div>

<p><b>Note:</b> Keep in mind that this is CloudFormation condition - condition won&#x2019;t be evaluated during pipeline execution but at the moment of pipeline creation time, so it will be ether always defined or always absent.</p></section><section>
<h2><a name="Actions"></a>Actions</h2>
<p>Currently, following action types have simplified definition (using <code>ActionType</code> property instead of <code>ActionTypeId</code>).</p><section>
<h3><a name="CloudFormationDeploy"></a>CloudFormationDeploy</h3>
<p>Simplification of CloudFormation <code>CREATE_UPDATE</code> action mode:</p>

<div class="source">
<div class="source"><pre class="prettyprint">Actions:
    DeployStack:
        Type: &quot;CloudFormationDeploy&quot;
        Configuration:
            StackName: !Sub &quot;${AWS::StackName}-api&quot;
            RoleArn: !GetAtt &quot;InfrastructureRole.Arn&quot;
            TemplatePath: &quot;checkout::infrastructure/cloudformation/api.yaml&quot;
            TemplateConfiguration: &quot;checkout::infrastructure/cloudformation/config-root.json&quot;
        Parameter:
            ProjectVersion: !Ref &quot;ProjectVersion&quot;
            HostedZoneId: &quot;#{PreviousStage:DNS.HostedZoneId}&quot;
</pre></div></div>

<ul>

<li>Dependencies are detected by references and will be used to compute <code>RunOrder</code> dynamically.</li>
<li>You don&#x2019;t need to specify <code>Namespace</code>, it will be resolved by a macro.</li>
<li><code>Capabilities</code> property is set to <code>CAPABILITY_NAMED_IAM,CAPABILITY_AUTO_EXPAND</code>.</li>
<li>Artifacts used for <code>TemplatePath</code> and <code>TemplateConfiguration</code> are automatically added to input artifacts list.</li>
<li>Parameters are specified as <code>Parameters</code> property directly on action level in a structured way instead of blob.</li>
</ul></section><section>
<h3><a name="CodeBuild"></a>CodeBuild</h3>
<p>This type simplifies <b>CodeBuild</b> project integration:</p>

<div class="source">
<div class="source"><pre class="prettyprint">Actions:
    RunProject:
        Type: &quot;CodeBuild&quot;
        Project: !Ref &quot;BuildProject&quot;
</pre></div></div>
</section><section>
<h3><a name="S3Deploy"></a>S3Deploy</h3>
<p>Pipeline source that saves artifact to S3:</p>

<div class="source">
<div class="source"><pre class="prettyprint">Actions:
    Checkout:
        Type: &quot;S3Deploy&quot;
        Bucket: !Ref &quot;ArtifactsBucket&quot;
        ObjectKey: &quot;checkout.zip&quot;
        InputArtifacts:
            - &quot;checkout&quot;
</pre></div></div>
</section><section>
<h3><a name="S3Promote"></a>S3Promote</h3>
<p>This type is a specific case of S3 deployment that is dedicated for multi-stage pipelines - it automatically maps other action of type <code>S3Source</code> (see below) to other bucket.</p>

<div class="source">
<div class="source"><pre class="prettyprint">Actions:
    Promote:
        Type: &quot;S3Promote&quot;
        Source: &quot;StageName:CheckoutAction&quot;
        Bucket: !Ref &quot;NextStageBucket&quot;
</pre></div></div>

<ul>

<li>You don&#x2019;t need to specify input artifact for this action - it takes artifacts of referred S3 source action.</li>
<li><code>ObjectKey</code> is replicated from source reference.</li>
<li><code>CannedACL</code> is set to <code>&quot;bucket-owner-full-control&quot;</code>.</li>
</ul></section><section>
<h3><a name="S3Source"></a>S3Source</h3>
<p>Pipeline source that takes S3 object:</p>

<div class="source">
<div class="source"><pre class="prettyprint">Actions:
    Checkout:
        Type: &quot;S3Source&quot;
        Bucket: !Ref &quot;ArtifactsBucket&quot;
        ObjectKey: &quot;checkout.zip&quot;
        OutputArtifacts:
            - &quot;checkout&quot;
</pre></div></div>
</section></section><section>
<h2><a name="Simplifications"></a>Simplifications</h2>
<ul>

<li>You can use plain value (including references) as <code>ArtifactStore</code> or entries in <code>ArtifactStores</code> and it will be converted to <code>S3</code> references:

<div class="source">
<div class="source"><pre class="prettyprint">DeployPipeline:
    Type: &quot;AWS::CodePipeline::Pipeline&quot;
    Properties:
        ArtifactStores:
            -
                Region: !Ref &quot;AWS::Region&quot;
                ArtifactStore: !ImportValue &quot;root:v1:codepipeline:artifacts-bucket:name&quot;
            -
                Region: &quot;us-east-1&quot;
                ArtifactStore: !ImportValue &quot;root:v1:codepipeline:us-east-1-artifacts-bucket:name&quot;

</pre></div></div>
</li>
<li>In action&#x2019;s <code>ActionTypeId</code> properties <code>Owner</code> and <code>Version</code> have default values as <code>&quot;AWS&quot;</code> and <code>&quot;1&quot;</code> respectively.</li>
<li>Input and output artifacts can be defined as list of strings:

<div class="source">
<div class="source"><pre class="prettyprint">SomeActions:
    InputArtifacts:
        - &quot;checkout&quot;
    OutputArtifacts:
        - &quot;build&quot;
</pre></div></div>
</li>
</ul></section>
        </div>
      </div>
    </div>
    <hr/>
    <footer>
      <div class="container-fluid">
        <div class="row-fluid">
            <p>Copyright &copy;2021&#x2013;2023
<a href="https://wrzasq.pl/">Rafał Wrzeszcz - Wrzasq.pl</a>.
All rights reserved.        <li id="publishDate" class="pull-right">Last Published: 2023-07-11</li>
          <li id="projectVersion" class="pull-right">Version: 1.2.2</li>
</p>
        </div>
        </div>
    </footer>
    </body>
</html>
