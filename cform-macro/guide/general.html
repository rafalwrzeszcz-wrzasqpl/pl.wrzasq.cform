<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.9.2 at 2022-01-10 
 | Rendered using Apache Maven Fluido Skin 1.6
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20220110" />
    <meta http-equiv="Content-Language" content="en" />
    <title>CloudFormation macro processor. &#x2013; </title>
    <link rel="stylesheet" href="../css/apache-maven-fluido-1.6.min.css" />
    <link rel="stylesheet" href="../css/site.css" />
    <link rel="stylesheet" href="../css/print.css" media="print" />
      <script type="text/javascript" src="../js/apache-maven-fluido-1.6.min.js"></script>
      </head>
    <body class="topBarDisabled">
      <div class="container-fluid">
      <div id="banner">
        <div class="pull-left"><div id="bannerLeft"><h2>CloudFormation macro processor.</h2>
</div>
</div>
        <div class="pull-right"><a href="https://wrzasq.pl" id="bannerRight"><h2><img src="https://static.wrzasq.pl/images/wrzasqpl.png" alt="Wrzasq.pl"/></h2>
</a></div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
        </ul>
      </div>
      <div class="row-fluid">
        <div id="leftColumn" class="span2">
          <div class="well sidebar-nav">
<ul class="nav nav-list">
          <li class="nav-header">Main</li>
    <li><a href="https://github.com/rafalwrzeszcz-wrzasqpl/pl.wrzasq.cform/" class="externalLink" title="GitHub project"><span class="none"></span>GitHub project</a>  </li>
    <li><a href="https://wrzasq.pl/" class="externalLink" title="Wrzasq.pl"><span class="none"></span>Wrzasq.pl</a>  </li>
    <li><a href="https://www.facebook.com/wrzasqpl" class="externalLink" title="Wrzasq.pl @ Facebook"><span class="none"></span>Wrzasq.pl @ Facebook</a>  </li>
    <li><a href="https://www.linkedin.com/company/wrzasq-pl/" class="externalLink" title="Wrzasq.pl @ LinkedIn"><span class="none"></span>Wrzasq.pl @ LinkedIn</a>  </li>
          <li class="nav-header">Parent Project</li>
    <li><a href="../../index.html" title="WrzasqPl CForm"><span class="none"></span>WrzasqPl CForm</a>  </li>
          <li class="nav-header">Guide</li>
    <li><a href="../guide/deployment.html" title="Deployment"><span class="none"></span>Deployment</a>  </li>
    <li><a href="../guide/apigateway.html" title="API Gateway"><span class="none"></span>API Gateway</a>  </li>
    <li><a href="../guide/codepipeline.html" title="CodePipeline"><span class="none"></span>CodePipeline</a>  </li>
    <li class="active"><a href="#"><span class="none"></span>General improvements</a>
  </li>
          <li class="nav-header">Project Documentation</li>
    <li><a href="../project-info.html" title="Project Information"><span class="icon-chevron-right"></span>Project Information</a>  </li>
    <li><a href="../project-reports.html" title="Project Reports"><span class="icon-chevron-right"></span>Project Reports</a>  </li>
  </ul>
          <hr />
          <div id="poweredBy">
              <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
  <a href="https://maven.apache.org/" title="Maven" class="builtBy"><img class="builtBy"  alt="Apache Maven" src="https://maven.apache.org/images/logos/maven-feather.png"    /></a>
<a href="https://wrzasq.pl" title="Wrzasq.pl" class="builtBy"><img class="builtBy"  alt="Wrzasq.pl" src="https://static.wrzasq.pl/images/wrzasqpl.png"    /></a>
              </div>
          </div>
        </div>
        <div id="bodyColumn"  class="span10" >
<!---
# This file is part of the pl.wrzasq.cform.
#
# @license http://mit-license.org/ The MIT license
# @copyright 2021 © by Rafał Wrzeszcz - Wrzasq.pl.
-->
<p>Apart from big things like API and pipeline definitions macro also handles many minor things that simplifies common code duplication parts in many <b>CloudFormation</b> templates. This page presents list of changes that macro applies.</p>
<p>However, main rule when working on macro transformations is to keep it transparent. For all of these cases native <b>CloudFormation</b> notations are supported and only in case when simplified notation is detected the transformation is applied. In principle, it is possible to include macro in any template, and it should just work transparently.</p>
<p>Keep in ming that despite all examples are presented in <b>YAML</b> notation you can use them also in <b>JSON</b> - macro is applied to template structure not its document. In some places the conventions needed to be picked to ensure unambiguity and predictability. These conventions differ from native CloudFormation conventions intentionally to avoid collisions and predictability is highly wanted mainly to avoid unattended template changes which would result in physical resources changes.</p>
<p><b>Note:</b> Macro handlers work as a pre-processors, they do not have any execution-time information - they operate on plain template structure so there are certain limitations to it. Macro is just a template transformation which modifies it before executing by CloudFormation.</p>
<h1>Simplifications</h1>
<p>Primarily, there are some simplifications that reduces verbosity of the template source code mapping some simple properties into their full representations.</p><section>
<h2><a name="CodeBuild"></a>CodeBuild</h2>
<ul>

<li>If you specify <code>Cache</code> as plain value (string or <code>Fn::</code> call) it will be expanded into <code>S3</code> type with <code>Location</code> taken as the value:

<div class="source">
<div class="source"><pre class="prettyprint">CachedProject:
    Type: &quot;AWS::CodeBuild::Project&quot;
    Properties:
        ServiceRole: !ImportValue &quot;root:v1:codebuild:role:name&quot;
        Environment:
            Image: &quot;maven:3.6.2-jdk-11&quot;
        # will be expanded into { &quot;Type&quot;: &quot;S3&quot;, &quot;Location&quot;: !Sub &quot;${CacheBucketName}/integrations&quot; }
        Cache: !Sub &quot;${CacheBucketName}/integrations&quot; 
</pre></div></div>
</li>
<li><code>Artifacts</code> section will be automatically set to <code>S3</code> if there is a <code>Location</code> property:

<div class="source">
<div class="source"><pre class="prettyprint">PipelineProject:
    Type: &quot;AWS::CodeBuild::Project&quot;
    Properties:
        ServiceRole: !ImportValue &quot;root:v1:codebuild:role:name&quot;
        Environment:
            Image: &quot;maven:3.6.2-jdk-11&quot;
        Artifacts:
            Location: !ImportValue &quot;root:v1:codepipeline:artifacts-bucket:name&quot;
            Path: !Ref &quot;ProjectName&quot;
            Name: &quot;checkout.zip&quot;
            Packaging: &quot;ZIP&quot;
            # this is not needed
            # Type: &quot;S3&quot;
</pre></div></div>
</li>
<li>Plain <code>EnvironmentVariables</code> can be specified as a mapping:

<div class="source">
<div class="source"><pre class="prettyprint">PipelineProject:
    Type: &quot;AWS::CodeBuild::Project&quot;
    Properties:
        Environment:
            EnvironmentVariables:
                ServiceUrl: &quot;https://example.com&quot;
                ServiceVersion: &quot;v1&quot;
</pre></div></div>
</li>
</ul></section><section>
<h2><a name="DynamoDb"></a>DynamoDb</h2>
<ul>

<li>All key attributes (both from the table itself and secondary indices) that are not in <code>AttributeDefinitions</code> schema are added automatically with type <code>S</code>:

<div class="source">
<div class="source"><pre class="prettyprint">SomeTable:
    Type: &quot;AWS::DynamoDB::Table&quot;
    DeletionPolicy: &quot;Retain&quot;
    Properties:
        AttributeDefinitions:
            -
                AttributeName: &quot;version&quot;
                AttributeType: &quot;N&quot;
            # clientId and apiKey will be added automatically with Type: &quot;S&quot;
        KeySchema:
            -
                AttributeName: &quot;clientId&quot;
                KeyType: &quot;HASH&quot;
            -
                AttributeName: &quot;version&quot;
                KeyType: &quot;RANGE&quot;
        GlobalSecondaryIndexes:
            -
                IndexName: &quot;keys&quot;
                KeySchema:
                    -
                        AttributeName: &quot;clientId&quot;
                        KeyType: &quot;HASH&quot;
                    -
                        AttributeName: &quot;apiKey&quot;
                        KeyType: &quot;RANGE&quot;
</pre></div></div>
</li>
</ul></section><section>
<h2><a name="IAM"></a>IAM</h2>
<ul>

<li>Property <code>Policies</code> in <code>AWS::IAM::Group</code>, <code>AWS::IAM::Role</code> and <code>AWS::IAM::User</code> can be written in more compat way as a mapping from policy name to policy document and policy document gets wrapped with <code>Statement</code> and <code>Version</code> envelope:

<div class="source">
<div class="source"><pre class="prettyprint">ApiLambdaRole:
    Type: &quot;AWS::IAM::Role&quot;
    Properties:
        AssumeRolePolicyDocument:
            -
                Action: &quot;sts:AssumeRole&quot;
                Effect: &quot;Allow&quot;
                Principal:
                    Service:
                        - &quot;lambda.amazonaws.com&quot;
        ManagedPolicyArns:
            - &quot;arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole&quot;
            - &quot;arn:aws:iam::aws:policy/AWSXrayWriteOnlyAccess&quot;
        Policies:
            AllowUsingSomeTable:
                -
                    Action:
                        - &quot;dynamodb:Query&quot;
                    Effect: &quot;Allow&quot;
                    Resource:
                        - !Sub &quot;${SomeTable.Arn}/index/keys&quot;
</pre></div></div>
</li>
<li>Property <code>PolicyDocument</code> in <code>AWS::IAM::ManagedPolicy</code> and <code>AWS::IAM::Policy</code> and <code>AssumeRolePolicyDocument</code> in <code>AWS::IAM::Role</code> are expanded same way (as a single policy statement).</li>
</ul>
<h1>Automatic log group</h1>
<p>For <code>AWS::Lambda::Function</code>, <code>AWS::Serverless::Function</code> and <code>AWS::CodeBuild::Project</code> resources you can specify new property - <code>LogsRetentionInDays</code>. When it is detected, corresponding <code>AWS::Logs::LogGroup</code> resource is automatically defined with name that follows convention to provision log group that will be used by the function or build project.</p>
<p><b>Note:</b> Log group can not exist at the moment of template execution, otherwise <b>CloudFormation</b> will fail to provision it. If you already have such log group, you need to manually delete it, or import existing log group into the stack.</p>
<h1><code>Fn::ImportValue</code> within <code>Fn::Sub</code></h1>
<p><a class="externalLink" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/intrinsic-function-reference-sub.html"><code>Fn::Sub</code></a> was a big simplification on its own when it was introduced - before that you had to handle each string concatenation with spaghetti <code>Fn::Join</code> call with empty separator. The simplest case is when you can put all your placeholders into string parameters for further interpolation - eg. <code>!Sub &quot;arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${RestApiId}/${ApiStage}/${Table.Arn}&quot;</code>. If you use something else than simple references or attributes you unfortunately need to switch to more verbose structure:</p>

<div class="source">
<div class="source"><pre class="prettyprint">SomeProperty:
    &quot;Fn::Sub&quot;:
        - &quot;Your ${Message}&quot;
        -
            Message: !ImportValue &quot;RootBucketName&quot;
</pre></div></div>

<p>This is very common in case of <code>Fn::ImportValue</code> inserted into <code>Fn::Sub</code>. With the macro you can interpolate import values directly into pattern string to simplify the notation just the same way as replacements for <code>Ref</code> and <code>Fn::Sub</code> calls - all placeholders beginning with <code>Import:</code> prefix are replaced with placeholders backed by <code>Fn::ImportValue</code>:</p>

<div class="source">
<div class="source"><pre class="prettyprint">SomeProperty: !Sub &quot;Your ${Import:RootBucketName}&quot;
</pre></div></div>

<h1>Sensible defaults</h1>
<p>Additionally, some vales are specified as defaults - these are the cases when the values are required by <b>CloudFormation</b> anyway, so if you use the following setup presented here, you can omit it and it will be applied implicitly.</p></section><section>
<h2><a name="CodeBuild"></a>CodeBuild</h2>
<ul>

<li>If you don&#x2019;t specify <code>Source</code> or <code>Artifacts</code> property of the project it will be set to <code>CODEPIPELINE</code> type.

<div class="source">
<div class="source"><pre class="prettyprint"># this effectively defines project for CodePipeline
PipelineProject:
    Type: &quot;AWS::CodeBuild::Project&quot;
    Properties:
        ServiceRole: !ImportValue &quot;root:v1:codebuild:role:name&quot;
        Environment:
            Image: &quot;maven:3.6.2-jdk-11&quot;
</pre></div></div>
</li>
<li>Environment build type is by default set to <code>LINUX_CONTAINER</code> and compute type to <code>BUILD_GENERAL1_SMALL</code>.</li>
</ul></section>
        </div>
      </div>
    </div>
    <hr/>
    <footer>
      <div class="container-fluid">
        <div class="row-fluid">
            <p>Copyright &copy;2021&#x2013;2022
<a href="https://wrzasq.pl/">Rafał Wrzeszcz - Wrzasq.pl</a>.
All rights reserved.        <li id="publishDate" class="pull-right">Last Published: 2022-01-10</li>
          <li id="projectVersion" class="pull-right">Version: 1.1.8</li>
</p>
        </div>
        </div>
    </footer>
    </body>
</html>
