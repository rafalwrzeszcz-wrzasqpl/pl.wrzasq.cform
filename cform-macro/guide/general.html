<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 2.0.0 at $dateFormat.format( $currentDate ) 
 | Rendered using Apache Maven Fluido Skin 1.6
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="" lang="">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Content-Language" content="" />
    <title>CloudFormation macro processor.</title>
    <link rel="stylesheet" href="../css/apache-maven-fluido-1.6.min.css" />
    <link rel="stylesheet" href="../css/site.css" />
    <link rel="stylesheet" href="../css/print.css" media="print" />
      <script type="text/javascript" src="../js/apache-maven-fluido-1.6.min.js"></script>
      </head>
    <body class="topBarDisabled">
      <div class="container-fluid">
      <div id="banner">
        <div class="pull-left"><div id="bannerLeft"><h2>CloudFormation macro processor.</h2>
</div>
</div>
        <div class="pull-right"><a href="https://wrzasq.pl" id="bannerRight"><h2><img src="https://static.wrzasq.pl/images/wrzasqpl.png" alt="Wrzasq.pl"/></h2>
</a></div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
        </ul>
      </div>
      <div class="row-fluid">
        <div id="leftColumn" class="span2">
          <div class="well sidebar-nav">
<ul class="nav nav-list">
          <li class="nav-header">Main</li>
    <li><a href="https://github.com/rafalwrzeszcz-wrzasqpl/pl.wrzasq.cform/" class="externalLink" title="GitHub project"><span class="none"></span>GitHub project</a>  </li>
    <li><a href="https://wrzasq.pl/" class="externalLink" title="Wrzasq.pl"><span class="none"></span>Wrzasq.pl</a>  </li>
    <li><a href="https://www.facebook.com/wrzasqpl" class="externalLink" title="Wrzasq.pl @ Facebook"><span class="none"></span>Wrzasq.pl @ Facebook</a>  </li>
    <li><a href="https://www.linkedin.com/company/wrzasq-pl/" class="externalLink" title="Wrzasq.pl @ LinkedIn"><span class="none"></span>Wrzasq.pl @ LinkedIn</a>  </li>
          <li class="nav-header">Parent Project</li>
    <li><a href="../../index.html" title="WrzasqPl CForm"><span class="none"></span>WrzasqPl CForm</a>  </li>
          <li class="nav-header">Guide</li>
    <li><a href="../guide/deployment.html" title="Deployment"><span class="none"></span>Deployment</a>  </li>
    <li><a href="../guide/matrix.html" title="Matrix resources"><span class="none"></span>Matrix resources</a>  </li>
    <li><a href="../guide/apigateway.html" title="API Gateway"><span class="none"></span>API Gateway</a>  </li>
    <li><a href="../guide/codepipeline.html" title="CodePipeline"><span class="none"></span>CodePipeline</a>  </li>
    <li class="active"><a href="#"><span class="none"></span>General improvements</a>
  </li>
          <li class="nav-header">Project Documentation</li>
    <li><a href="../project-info.html" title="Project Information"><span class="icon-chevron-right"></span>Project Information</a>  </li>
    <li><a href="../project-reports.html" title="Project Reports"><span class="icon-chevron-right"></span>Project Reports</a>  </li>
  </ul>
          <hr />
          <div id="poweredBy">
              <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
  <a href="https://maven.apache.org/" title="Maven" class="builtBy"><img class="builtBy"  alt="Maven" src="../images/logos/maven-feather.png"    /></a>
<a href="https://wrzasq.pl" title="Wrzasq.pl" class="builtBy"><img class="builtBy"  alt="Wrzasq.pl" src="../images/logos/maven-feather.png"    /></a>
              </div>
          </div>
        </div>
        <div id="bodyColumn"  class="span10" >
<!---
# This file is part of the pl.wrzasq.cform.
#
# @license http://mit-license.org/ The MIT license
# @copyright 2021 - 2022 © by Rafał Wrzeszcz - Wrzasq.pl.
-->
<p>Apart from big things like API and pipeline definitions macro also handles many minor things that simplifies common
code duplication parts in many <strong>CloudFormation</strong> templates. This page presents list of changes that macro applies.</p>
<p>However, main rule when working on macro transformations is to keep it transparent. For all of these cases native
<strong>CloudFormation</strong> notations are supported and only in case when simplified notation is detected the transformation is
applied. In principle, it is possible to include macro in any template, and it should just work transparently.</p>
<p>Keep in ming that despite all examples are presented in <strong>YAML</strong> notation you can use them also in <strong>JSON</strong> - macro is
applied to template structure not its document. In some places the conventions needed to be picked to ensure unambiguity
and predictability. These conventions differ from native CloudFormation conventions intentionally to avoid collisions
and predictability is highly wanted mainly to avoid unattended template changes which would result in physical resources
changes.</p>
<p><strong>Note:</strong> Macro handlers work as a pre-processors, they do not have any execution-time information - they operate on
plain template structure so there are certain limitations to it. Macro is just a template transformation which modifies
it before executing by CloudFormation.</p><section><a id="Simplifications"></a>
<h1>Simplifications</h1>
<p>Primarily, there are some simplifications that reduces verbosity of the template source code mapping some simple
properties into their full representations.</p><section><a id="CodeBuild"></a>
<h2>CodeBuild</h2>
<ul>

<li>If you specify <code>Cache</code> as plain value (string or <code>Fn::</code> call) it will be expanded into <code>S3</code> type with <code>Location</code>
taken as the value:

<pre><code class="language-yaml">CachedProject:
    Type: &quot;AWS::CodeBuild::Project&quot;
    Properties:
        ServiceRole: !ImportValue &quot;root:v1:codebuild:role:name&quot;
        Environment:
            Image: &quot;maven:3.6.2-jdk-11&quot;
        # will be expanded into { &quot;Type&quot;: &quot;S3&quot;, &quot;Location&quot;: !Sub &quot;${CacheBucketName}/integrations&quot; }
        Cache: !Sub &quot;${CacheBucketName}/integrations&quot; 
</code></pre></li>
<li><code>Artifacts</code> section will be automatically set to <code>S3</code> if there is a <code>Location</code> property:

<pre><code class="language-yaml">PipelineProject:
    Type: &quot;AWS::CodeBuild::Project&quot;
    Properties:
        ServiceRole: !ImportValue &quot;root:v1:codebuild:role:name&quot;
        Environment:
            Image: &quot;maven:3.6.2-jdk-11&quot;
        Artifacts:
            Location: !ImportValue &quot;root:v1:codepipeline:artifacts-bucket:name&quot;
            Path: !Ref &quot;ProjectName&quot;
            Name: &quot;checkout.zip&quot;
            Packaging: &quot;ZIP&quot;
            # this is not needed
            # Type: &quot;S3&quot;
</code></pre></li>
<li>Plain <code>EnvironmentVariables</code> can be specified as a mapping:

<pre><code class="language-yaml">PipelineProject:
    Type: &quot;AWS::CodeBuild::Project&quot;
    Properties:
        Environment:
            EnvironmentVariables:
                ServiceUrl: &quot;https://example.com&quot;
                ServiceVersion: &quot;v1&quot;
</code></pre></li>
</ul></section><section><a id="DynamoDb"></a>
<h2>DynamoDb</h2>
<ul>

<li>All key attributes (both from the table itself and secondary indices) that are not in <code>AttributeDefinitions</code> schema
are added automatically with type <code>S</code>:

<pre><code class="language-yaml">SomeTable:
    Type: &quot;AWS::DynamoDB::Table&quot;
    DeletionPolicy: &quot;Retain&quot;
    Properties:
        AttributeDefinitions:
            -
                AttributeName: &quot;version&quot;
                AttributeType: &quot;N&quot;
            # clientId and apiKey will be added automatically with Type: &quot;S&quot;
        KeySchema:
            -
                AttributeName: &quot;clientId&quot;
                KeyType: &quot;HASH&quot;
            -
                AttributeName: &quot;version&quot;
                KeyType: &quot;RANGE&quot;
        GlobalSecondaryIndexes:
            -
                IndexName: &quot;keys&quot;
                KeySchema:
                    -
                        AttributeName: &quot;clientId&quot;
                        KeyType: &quot;HASH&quot;
                    -
                        AttributeName: &quot;apiKey&quot;
                        KeyType: &quot;RANGE&quot;
</code></pre></li>
</ul></section><section><a id="IAM"></a>
<h2>IAM</h2>
<ul>

<li>Property <code>Policies</code> in <code>AWS::IAM::Group</code>, <code>AWS::IAM::Role</code> and <code>AWS::IAM::User</code> can be written in more compat way as
a mapping from policy name to policy document and policy document gets wrapped with <code>Statement</code> and <code>Version</code>
envelope:

<pre><code class="language-yaml">ApiLambdaRole:
    Type: &quot;AWS::IAM::Role&quot;
    Properties:
        AssumeRolePolicyDocument:
            -
                Action: &quot;sts:AssumeRole&quot;
                Effect: &quot;Allow&quot;
                Principal:
                    Service:
                        - &quot;lambda.amazonaws.com&quot;
        ManagedPolicyArns:
            - &quot;arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole&quot;
            - &quot;arn:aws:iam::aws:policy/AWSXrayWriteOnlyAccess&quot;
        Policies:
            AllowUsingSomeTable:
                -
                    Action:
                        - &quot;dynamodb:Query&quot;
                    Effect: &quot;Allow&quot;
                    Resource:
                        - !Sub &quot;${SomeTable.Arn}/index/keys&quot;
</code></pre></li>
<li>Property <code>PolicyDocument</code> in <code>AWS::IAM::ManagedPolicy</code> and <code>AWS::IAM::Policy</code> and <code>AssumeRolePolicyDocument</code> in
<code>AWS::IAM::Role</code> are expanded same way (as a single policy statement).</li>
</ul></section><section><a id="Connect"></a>
<h2>Connect</h2>
<ul>

<li>In <code>AWS::Connect::ContactFlow</code> resource <code>Content</code> can be defined as regular template structure and it will be
serialized to JSON (intrinsic function calls will be maintained).</li>
<li>Flow schema version will be set to <code>2019-10-30</code> by default (no need for manual definition).

<pre><code class="language-yaml">ConnectFlow:
    Type: &quot;AWS::Connect::ContactFlow&quot;
    Properties:
        InstanceArn: !GetAtt &quot;ConnectInstance.Arn&quot;
        Name: &quot;Default Flow&quot;
        Type: &quot;CONTACT_FLOW&quot;
        Content:
            StartAction: &quot;start&quot;
            Actions:
                -
                    Identifier: &quot;start&quot;
                    Type: &quot;UpdateContactTargetQueue&quot;
                    Parameters:
                        QueueId: !Ref &quot;OrderQueueId&quot;
                    Transitions:
                        NextAction: &quot;order_number&quot;
                        Errors:
                            -
                                ErrorType: &quot;NoMatchingError&quot;
                                NextAction: &quot;end&quot;
</code></pre></li>
</ul></section><section><a id="SecretsManager"></a>
<h2>SecretsManager</h2>
<ul>

<li>In <code>AWS::SecretsManager::Secret</code> initial value can be specified using <code>SecretContent</code> property, that will be
serialized as <code>SecretString</code> JSON (intrinsic function calls will be maintained).

<pre><code class="language-yaml">MySecret:
    Type: &quot;AWS::SecretsManager::Secret&quot;
    Properties:
        SecretContent:
            OAuthUrl: !Ref &quot;TokenEndpoint&quot;
            # these will be entered in console
            ClientId: &quot;&quot;
            ClientSecret: &quot;&quot;
</code></pre></li>
</ul></section></section><section><a id="Automatic_log_group"></a>
<h1>Automatic log group</h1>
<p>For <code>AWS::Lambda::Function</code>, <code>AWS::Serverless::Function</code> and <code>AWS::CodeBuild::Project</code> resources you can specify new
property - <code>LogsRetentionInDays</code>. When it is detected, corresponding <code>AWS::Logs::LogGroup</code> resource is automatically
defined with name that follows convention to provision log group that will be used by the function or build project.</p>
<p><strong>Note:</strong> Log group can not exist at the moment of template execution, otherwise <strong>CloudFormation</strong> will fail to
provision it. If you already have such log group, you need to manually delete it, or import existing log group into the
stack.</p></section><section><a id="Fn.3A.3AImportValue_within_Fn.3A.3ASub"></a>
<h1><code>Fn::ImportValue</code> within <code>Fn::Sub</code></h1>
<p><a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/intrinsic-function-reference-sub.html" class="externalLink"><code>Fn::Sub</code></a> was a
big simplification on its own when it was introduced - before that you had to handle each string concatenation with
spaghetti <code>Fn::Join</code> call with empty separator. The simplest case is when you can put all your placeholders into string
parameters for further interpolation - eg.
<code>!Sub &quot;arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${RestApiId}/${ApiStage}/${Table.Arn}&quot;</code>. If you use
something else than simple references or attributes you unfortunately need to switch to more verbose structure:</p>

<pre><code class="language-yaml">SomeProperty:
    &quot;Fn::Sub&quot;:
        - &quot;Your ${Message}&quot;
        -
            Message: !ImportValue &quot;RootBucketName&quot;
</code></pre>
<p>This is very common in case of <code>Fn::ImportValue</code> inserted into <code>Fn::Sub</code>. With the macro you can interpolate import
values directly into pattern string to simplify the notation just the same way as replacements for <code>Ref</code> and <code>Fn::Sub</code>
calls - all placeholders beginning with <code>Import:</code> prefix are replaced with placeholders backed by <code>Fn::ImportValue</code>:</p>

<pre><code class="language-yaml">SomeProperty: !Sub &quot;Your ${Import:RootBucketName}&quot;
</code></pre></section><section><a id="Sensible_defaults"></a>
<h1>Sensible defaults</h1>
<p>Additionally, some vales are specified as defaults - these are the cases when the values are required by
<strong>CloudFormation</strong> anyway, so if you use the following setup presented here, you can omit it and it will be applied
implicitly.</p><section><a id="CodeBuild_1"></a>
<h2>CodeBuild</h2>
<ul>

<li>If you don't specify <code>Source</code> or <code>Artifacts</code> property of the project it will be set to <code>CODEPIPELINE</code> type.

<pre><code class="language-yaml"># this effectively defines project for CodePipeline
PipelineProject:
    Type: &quot;AWS::CodeBuild::Project&quot;
    Properties:
        ServiceRole: !ImportValue &quot;root:v1:codebuild:role:name&quot;
        Environment:
            Image: &quot;maven:3.6.2-jdk-11&quot;
</code></pre></li>
<li>Environment build type is by default set to <code>LINUX_CONTAINER</code> and compute type to <code>BUILD_GENERAL1_SMALL</code>.</li>
</ul></section><section><a id="Kinesis"></a>
<h2>Kinesis</h2>
<ul>

<li>If you don't specify <code>ShardsCount</code> for <strong>Kinesis</strong> data stream and you don't explicitly set <code>StreamModeDetails</code>
property, mode will be set to <code>ON_DEMAND</code>.</li>
</ul></section></section>
        </div>
      </div>
    </div>
    <hr/>
    <footer>
      <div class="container-fluid">
        <div class="row-fluid">
            <p>Copyright &copy;2021&#x2013;${currentYear}
<a href="https://wrzasq.pl/">Rafał Wrzeszcz - Wrzasq.pl</a>.
All rights reserved.        <li id="publishDate" class="pull-right">$i18n.getString( "site-renderer", $locale, "template.lastpublished" ): $dateValue</li>
          <li id="projectVersion" class="pull-right">$i18n.getString( "site-renderer", $locale, "template.version" ): 1.4.10</li>
</p>
        </div>
        </div>
    </footer>
    </body>
</html>
