<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 2.0.0 at $dateFormat.format( $currentDate ) 
 | Rendered using Apache Maven Fluido Skin 1.6
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="" lang="">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Content-Language" content="" />
    <title>API Gateway – CloudFormation macro processor.</title>
    <link rel="stylesheet" href="../css/apache-maven-fluido-1.6.min.css" />
    <link rel="stylesheet" href="../css/site.css" />
    <link rel="stylesheet" href="../css/print.css" media="print" />
      <script type="text/javascript" src="../js/apache-maven-fluido-1.6.min.js"></script>
      </head>
    <body class="topBarDisabled">
      <div class="container-fluid">
      <div id="banner">
        <div class="pull-left"><div id="bannerLeft"><h2>CloudFormation macro processor.</h2>
</div>
</div>
        <div class="pull-right"><a href="https://wrzasq.pl" id="bannerRight"><h2><img src="https://static.wrzasq.pl/images/wrzasqpl.png" alt="Wrzasq.pl"/></h2>
</a></div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
        </ul>
      </div>
      <div class="row-fluid">
        <div id="leftColumn" class="span2">
          <div class="well sidebar-nav">
<ul class="nav nav-list">
          <li class="nav-header">Main</li>
    <li><a href="https://github.com/rafalwrzeszcz-wrzasqpl/pl.wrzasq.cform/" class="externalLink" title="GitHub project"><span class="none"></span>GitHub project</a>  </li>
    <li><a href="https://wrzasq.pl/" class="externalLink" title="Wrzasq.pl"><span class="none"></span>Wrzasq.pl</a>  </li>
    <li><a href="https://www.facebook.com/wrzasqpl" class="externalLink" title="Wrzasq.pl @ Facebook"><span class="none"></span>Wrzasq.pl @ Facebook</a>  </li>
    <li><a href="https://www.linkedin.com/company/wrzasq-pl/" class="externalLink" title="Wrzasq.pl @ LinkedIn"><span class="none"></span>Wrzasq.pl @ LinkedIn</a>  </li>
          <li class="nav-header">Parent Project</li>
    <li><a href="../../index.html" title="WrzasqPl CForm"><span class="none"></span>WrzasqPl CForm</a>  </li>
          <li class="nav-header">Guide</li>
    <li><a href="../guide/deployment.html" title="Deployment"><span class="none"></span>Deployment</a>  </li>
    <li><a href="../guide/matrix.html" title="Matrix resources"><span class="none"></span>Matrix resources</a>  </li>
    <li class="active"><a href="#"><span class="none"></span>API Gateway</a>
  </li>
    <li><a href="../guide/codepipeline.html" title="CodePipeline"><span class="none"></span>CodePipeline</a>  </li>
    <li><a href="../guide/general.html" title="General improvements"><span class="none"></span>General improvements</a>  </li>
          <li class="nav-header">Project Documentation</li>
    <li><a href="../project-info.html" title="Project Information"><span class="icon-chevron-right"></span>Project Information</a>  </li>
    <li><a href="../project-reports.html" title="Project Reports"><span class="icon-chevron-right"></span>Project Reports</a>  </li>
  </ul>
          <hr />
          <div id="poweredBy">
              <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
  <a href="https://maven.apache.org/" title="Maven" class="builtBy"><img class="builtBy"  alt="Maven" src="../images/logos/maven-feather.png"    /></a>
<a href="https://wrzasq.pl" title="Wrzasq.pl" class="builtBy"><img class="builtBy"  alt="Wrzasq.pl" src="../images/logos/maven-feather.png"    /></a>
              </div>
          </div>
        </div>
        <div id="bodyColumn"  class="span10" >
<!---
# This file is part of the pl.wrzasq.cform.
#
# @license http://mit-license.org/ The MIT license
# @copyright 2021 © by Rafał Wrzeszcz - Wrzasq.pl.
-->
<section><a id="API_Gateway"></a>
<h1>API Gateway</h1>
<p>One of the major improvements is streamlining <strong>API Gateway</strong> definition resources. Since single API definition contains
plenty of resource, many things need to be repeated. Macro handles dedicated structure that keeps entre API definition
in single structure and extracts it into separate resources also making some tedious tasks automated or at least
simplified.</p><section><a id="Definition"></a>
<h2>Definition</h2>
<p>Since REST API definition is combining many other resources it is separated into new template section <code>RestApis</code> - it is
a hash with API logical identifier (key in your template) as a key and API properties as each entry:</p>

<pre><code class="language-yaml">RestApis:
    MyApi:
        Authorizers:
            # authorizers definitions (see below)
        
        Models:
            # models definitions (see below)
        
        Resources:
            # API structure definition (see below)

        # all other properties will be mapped directly to API resources, so you can do:
        Name: &quot;my-public-api&quot;
</code></pre>
<p>Each REST API also defines <code>AWS::ApiGateway::Deployment</code> resource.</p>
<p>Defining any API using <code>RestApis</code> block also creates <code>AWS::ApiGateway::Account</code> and logging role for it.</p>
<p><strong>Note:</strong> On each level any property not mentioned directly here is passed to underlying resource, so in case of any
changes in native <strong>CloudFormation</strong> resources can be directly used in the macro.</p><section><a id="Authorizers"></a>
<h3>Authorizers</h3>

<pre><code class="language-yaml">Authorizers:
    SomeAuthorizerId:
        Type: &quot;TOKEN&quot;
        # this is not `!Sub`, this is an API gateway stage variable reference
        Lambda: &quot;${stageVariables.AuthorizerLambda}&quot;
        IdentitySource: &quot;method.request.header.Authorization&quot;
        AuthorizerResultTtlInSeconds: 3600
</code></pre>
<p>This is a completely ordinary authorizer definition except that it is automatically scoped within API. You also don't
need to define its name.</p>
<p><strong>Note:</strong> For <code>Lambda</code> property see &#x201c;Simplifications&#x201d; section.</p></section><section><a id="Models"></a>
<h3>Models</h3>

<pre><code class="language-yaml">Models:
    AccountInfo:
        Schema:
            type: &quot;object&quot;
            properties:
                accountName:
                    type: string
            required:
                - &quot;accountName&quot;
            additionalProperties: false
</code></pre>
<p>Again, definition of model is just a native <code>AWS::ApiGateway::Model</code> just automatically scoped to current API. Content
type, schema type and model title are, however, optional. You can see &#x201c;Simplifications&#x201d; section for details.</p></section><section><a id="API_structure"></a>
<h3>API structure</h3>
<p>The biggest simplification comes from converting excessive definitions of resource resources (well&#x2026; resources of
resources?) into structure definition - a little like Open API directly in CloudFormation template:</p>

<pre><code class="language-yaml"># keep in mind - this is `Resources` section of API not a top-level template section
Resources:
    /accounts:
        /{accountId}:
            &quot;@GET&quot;:
                # integration method - see below
            
            &quot;@DELETE&quot;:
                # integration method - see below
    /keys:
        &quot;@GET&quot;:
            # integration method - see below
</code></pre>
<p>There is literally no resource definition needed, as it is extracted directly from the tree-ish structure. It is just a
container for integration methods definitions.</p></section><section><a id="Integration"></a>
<h3>Integration</h3>

<pre><code class="language-yaml">&quot;@PUT&quot;:
    Authorizer: &quot;TokenAuthorizer&quot;
    RequestValidator: &quot;BODY_AND_PARAMETERS&quot;
    RequestModels:
        application/json: !Ref &quot;RestApi:V1:Model:TenantInfo&quot;
    RequestParameters:
        method.request.header.Authorization: true
        method.request.path.clientTenantId: true
        method.request.path.apiKey: true
    Integration:
        Lambda: &quot;${stageVariables.TenantKeySavingTarget}&quot;
        Credentials: !GetAtt &quot;ApiGatewayRole.Arn&quot;
        RequestTemplates:
            application/json: |
                {
                    &quot;tenantId&quot;: &quot;$context.authorizer.tenantId&quot;,
                    &quot;clientTenantId&quot;: &quot;$input.params('clientTenantId')&quot;,
                    &quot;apiKey&quot;: &quot;$input.params('apiKey')&quot;,
                    &quot;tenantInfo&quot;: $input.json('$')
                }
        IntegrationResponses:
            &quot;202&quot;:
                ResponseParameters:
                    method.response.header.Content-Type: &quot;'application/atom+xml'&quot;
            &quot;404&quot;:
                SelectionPattern: &quot;.*Tag not found.*&quot;
        PassthroughBehavior: &quot;NEVER&quot;
</code></pre>
<ul>

<li>So, again many of these is the same as <code>AWS::ApiGateway::Method</code> definition with some changes.</li>
<li>Method integration is automatically scoped to the API and containing resource and method is set to key where it is
defined - for <code>@PUT</code> its set to <code>PUT</code>.</li>
<li><code>Authorizer</code> (instead of <code>AuthorizerId</code>) is just an identifier from <code>Authorizers</code> definitions - macro converts it to
proper reference. <code>AuthorizerType</code> is also automatically assigned based on referred authorizer type.</li>
<li><code>RequestValidator</code> (instead of <code>RequestValidatorId</code>) is just one of the three values: <code>BODY_ONLY</code>,
<code>PARAMETERS_ONLY, or</code>BODY_AND_PARAMETERS`. Underlying validators are managed on-demand by macro.</li>
<li>Structure of <code>MethodResponses</code> and <code>Integration.IntegrationResponses</code> can be defined as maps, where keys become
<code>StatusCode</code> of defined responses (you can still use native notation of CloudFormation template).</li>
<li>If no <code>MethodResponses</code> is defined directly in the method it is built based on <code>Integration.IntegrationResponses</code> by
leaving <code>StatusCode</code> and <code>ResponseParameters</code> (if present) replaced by boolean flags instead of any values.</li>
</ul>
<p><strong>Note:</strong> Mapping keys in CloudFormation templates must be strings, even if it's <code>202</code> it must be wrapped within quotes!</p></section></section><section><a id="References"></a>
<h2>References</h2>
<p>You can refer to any resource defined by an API using specific notation (macro replaces them in <code>Ref</code>, <code>Fn::Sub</code> and
<code>Fn::GetAtt</code>):</p>
<ul>

<li><code>RestApi:MyApi</code> - returns API reference;</li>
<li><code>RestApi:MyApi:Deployment</code> - current API reference deployment;</li>
<li><code>RestApi:MyApi:Authorizer:AuthorizerIdentifier</code> - authorizer reference;</li>
<li><code>RestApi:MyApi:Validator:ValidatorIdentifier</code> - validator reference (it can be <code>BODY_ONLY</code>, <code>PARAMETERS_ONLY</code> or
<code>BODY_AND_PARAMETERS</code>);</li>
<li><code>RestApi:MyApi:Model:ModelIdentifier</code> - model reference;</li>
<li><code>RestApi:MyApi:Resource:ResourcePath</code> - resource reference;</li>
<li><code>RestApi:MyApi:Method:MethodAndResourcePath</code> - integration method reference.</li>
</ul>
<p>In case of <code>Resource</code> and <code>Method</code> references you need to use <code>%param%</code> instead of <code>{param}</code> path placeholder as that
would collide with <code>Fn::Sub</code> calls.</p>
<p>Examples of references:</p>
<ul>

<li><code>!Ref &quot;RestApi:MyApi:Authorizer:TokenAuthorizer&quot;</code></li>
<li><code>!GetAtt &quot;RestApi:MyApi.RootResourceId&quot;</code></li>
<li><code>!Sub &quot;${RestApi:MyApi:Resource:/%accountId%}&quot;</code></li>
</ul></section><section><a id="Simplifications"></a>
<h2>Simplifications</h2>
<ul>

<li>For integration <code>Type</code> defaults to <code>AWS</code> and <code>IntegrationHttpMethod</code> defaults to <code>POST</code>.</li>
<li>In integration methods and authorizers you can use <code>Lambda</code> property instead of <code>Uri</code> and <code>AuthorizerUri</code>
respectively - for that you can define just a Lambda function name (can be a reference or even stage variable).</li>
<li>Model content-type defaults to <code>application/json</code>, it's <code>$schema</code> to <code>http://json-schema.org/draft-04/schema#</code> and
<code>title</code> to its template identifier.</li>
<li>You don't need to define validators - macro will define them as they are needed basing on validation option picked
by a resource method integration.</li>
<li><code>Name</code> of validator is not required - it defaults to its template identifier.</li>
</ul></section><section><a id="Full_example"></a>
<h2>Full example</h2>

<pre><code class="language-yaml">
RestApis:
    # ApiGatewayV1
    V1:
        Name: &quot;MyTestApi&quot;
        Authorizers:
            TokenAuthorizer:
                Type: &quot;TOKEN&quot;
                Lambda: &quot;${stageVariables.AuthorizerLambda}&quot;
                IdentitySource: &quot;method.request.header.Authorization&quot;
                AuthorizerResultTtlInSeconds: 3600
        Models:
            AccountInfo:
                Schema:
                    type: &quot;object&quot;
                    properties:
                        accountName:
                            type: string
                    required:
                        - &quot;accountName&quot;
                    additionalProperties: false
        Resources:
            /accounts:
                /{accountId}:
                    &quot;@DELETE&quot;:
                        Authorizer: &quot;TokenAuthorizer&quot;
                        RequestValidator: &quot;PARAMETERS_ONLY&quot;
                        RequestParameters:
                            method.request.header.Authorization: true
                            method.request.path.accountId: true
                        Integration:
                            Lambda: &quot;${stageVariables.AccountDeletionTarget}&quot;
                            Credentials: !GetAtt &quot;ApiGatewayRole.Arn&quot;
                            RequestTemplates:
                                application/json: |
                                    {
                                        &quot;tenantId&quot;: &quot;$context.authorizer.tenantId&quot;,
                                        &quot;accountId&quot;: &quot;$input.params('accountId')&quot;
                                    }
                            IntegrationResponses:
                                &quot;202&quot;: {}
                            PassthroughBehavior: &quot;NEVER&quot;

                    /keys:
                        /{apiKey}:
                            &quot;@PUT&quot;:
                                Authorizer: &quot;TokenAuthorizer&quot;
                                RequestValidator: &quot;BODY_AND_PARAMETERS&quot;
                                RequestModels:
                                    application/json: !Ref &quot;RestApi:V1:Model:AccountInfo&quot;
                                RequestParameters:
                                    method.request.header.Authorization: true
                                    method.request.path.accountId: true
                                    method.request.path.apiKey: true
                                Integration:
                                    Lambda: &quot;${stageVariables.AccountKeySavingTarget}&quot;
                                    Credentials: !GetAtt &quot;ApiGatewayRole.Arn&quot;
                                    RequestTemplates:
                                        application/json: |
                                            {
                                                &quot;tenantId&quot;: &quot;$context.authorizer.tenantId&quot;,
                                                &quot;accountId&quot;: &quot;$input.params('accountId')&quot;,
                                                &quot;apiKey&quot;: &quot;$input.params('apiKey')&quot;,
                                                &quot;accountInfo&quot;: $input.json('$')
                                            }
                                    IntegrationResponses:
                                        &quot;202&quot;: {}
                                    PassthroughBehavior: &quot;NEVER&quot;

Outputs:
    RestApiId:
        Description: &quot;API Gateway ID.&quot;
        Value: !Ref &quot;RestApi:V1&quot;
</code></pre></section></section>
        </div>
      </div>
    </div>
    <hr/>
    <footer>
      <div class="container-fluid">
        <div class="row-fluid">
            <p>Copyright &copy;2021&#x2013;${currentYear}
<a href="https://wrzasq.pl/">Rafał Wrzeszcz - Wrzasq.pl</a>.
All rights reserved.        <li id="publishDate" class="pull-right">$i18n.getString( "site-renderer", $locale, "template.lastpublished" ): $dateValue</li>
          <li id="projectVersion" class="pull-right">$i18n.getString( "site-renderer", $locale, "template.version" ): 1.4.4</li>
</p>
        </div>
        </div>
    </footer>
    </body>
</html>
